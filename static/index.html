<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyst Dashboard - AquaSentry</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css" />
    
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #6c757d;
            --light-bg: #f8f9fa;
            --white: #fff;
            --border-color: #dee2e6;
            --text-dark: #212529;
            --text-light: #6c757d;
            --status-new: #0d6efd;
            --status-verified: #198754;
            --status-action: #ffc107;
            --status-false: #6c757d;
            --sentiment-pos: #198754;
            --sentiment-neg: #dc3545;
            --sentiment-neu: #6c757d;
        }
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--light-bg); 
            font-size: 16px; 
            color: var(--text-dark); 
            overflow: hidden;
        }

        #app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        nav.navbar { 
            background-color: var(--white); 
            border-bottom: 1px solid var(--border-color); 
            padding: 0.75rem 1.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 1001;
        }
        .navbar-brand { 
            display: flex;
            align-items: center;
            font-size: 1.4rem; 
            font-weight: 600; 
            color: var(--primary-color); 
            text-decoration: none; 
        }
        .navbar-icon {
            width: 32px;
            height: 32px;
            margin-right: 0.6rem;
            object-fit: contain;
        }
        .nav-center {
            display: flex;
            gap: 1rem;
        }
        .nav-links button { 
            background: none; 
            border: none; 
            padding: 0.5rem 1rem; 
            cursor: pointer; 
            font-size: 1rem; 
            color: var(--text-light); 
            border-radius: 6px; 
            font-weight: 500;
        }
        .nav-links button.active { 
            color: var(--primary-color); 
            background-color: rgba(13, 110, 253, 0.1); 
        }
        .nav-right {
            display: flex;
            align-items: center;
        }
        .logout-btn { 
            background-color: #dc3545; 
            color: white; 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 6px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .logout-btn:hover { background-color: #c82333; }

        main { 
            flex-grow: 1; 
            display: flex;
            overflow: hidden; 
            position: relative;
            height: 100%;
        }
        .view { 
            width: 100%; 
            height: 100%; 
            display: none; 
            flex-direction: column; 
            overflow-y: auto; 
        }
        .view.active { display: flex; }
        #map-view { padding: 0; position: relative; }
        #map { flex-grow: 1; border: none; }
        #table-view { padding: 1.5rem; }

        #filter-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 0.5rem;
        }
        #filter-controls button {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: 0.6rem 1.2rem; 
            margin-bottom: 0.25rem;
            cursor: pointer; 
            font-size: 0.95rem; 
            color: var(--text-dark); 
            border-radius: 6px; 
            font-weight: 500;
            text-align: left;
            transition: all 0.2s;
        }
        #filter-controls button:hover {
            background-color: var(--light-bg);
        }
        #filter-controls button.active {
            color: var(--primary-color); 
            background-color: rgba(13, 110, 253, 0.1);
            font-weight: 600;
        }

        .report-table { width: 100%; border-collapse: collapse; background-color: var(--white); box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        .report-table th, .report-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .report-table th { background-color: var(--light-bg); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; color: var(--text-light); }
        .report-table tbody tr { cursor: pointer; transition: background-color 0.15s; }
        .report-table tbody tr:hover { background-color: #f1f3f5; }
        .report-table tbody tr:last-child td { border-bottom: none; }
        
        .status-badge, .sentiment-badge { 
            display: inline-block; 
            padding: 0.25em 0.6em; 
            font-size: 0.75rem; 
            font-weight: 700; 
            line-height: 1; 
            text-align: center; 
            white-space: nowrap; 
            vertical-align: baseline; 
            border-radius: 0.375rem; 
            color: var(--white);
            text-transform: capitalize;
        }
        .status-new { background-color: var(--status-new); }
        .status-verified { background-color: var(--status-verified); }
        .status-action-taken { background-color: var(--status-action); color: var(--text-dark); }
        .status-false-alarm { background-color: var(--status-false); }

        .sentiment-positive { background-color: var(--sentiment-pos); }
        .sentiment-negative { background-color: var(--sentiment-neg); }
        .sentiment-neutral { background-color: var(--sentiment-neu); }

        aside.sidebar { position: absolute; right: -450px; top: 0; width: 400px; max-width: 90%; height: 100%; background-color: var(--white); box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: right 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; overflow-y: auto; }
        aside.sidebar.open { right: 0; }
        .sidebar-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; color: var(--text-dark); }
        .close-sidebar { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .sidebar-content { padding: 1.5rem; flex-grow: 1; }
        .sidebar-content img { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem; }
        .sidebar-content p { margin: 0 0 0.75rem; line-height: 1.6; }
        .sidebar-content strong { color: var(--text-dark); }
        
        .sidebar-actions { border-top: 1px solid var(--border-color); padding: 1rem 1.5rem; background-color: var(--light-bg); }
        .sidebar-actions label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .sidebar-actions textarea { width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; }
        .status-buttons button { padding: 0.6rem 1rem; margin-right: 0.5rem; margin-bottom: 0.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; color: var(--white); }
        button.status-new { background-color: var(--status-new); }
        button.status-verified { background-color: var(--status-verified); }
        button.status-action-taken { background-color: var(--status-action); color: var(--text-dark); }
        button.status-false-alarm { background-color: var(--status-false); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center; max-width: 320px; }
        .modal-content p { margin: 0 0 16px; font-size: 1.1rem; }
        .modal-btn { padding: 10px 18px; border-radius: 6px; border: none; background-color: var(--primary-color); color: white; font-weight: 500; cursor: pointer; }

        .leaflet-control-layers-base { padding: 5px; }
        .leaflet-control-layers-base label { font-size: 1rem; display: flex; align-items: center; }
        .leaflet-control-layers-base input { margin-right: 8px; }

        .custom-svg-icon {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid var(--white);
        }
        .custom-svg-icon svg {
            width: 16px;
            height: 16px;
            fill: var(--white);
        }
        .marker-color-blue { background-color: var(--status-new); }
        .marker-color-green { background-color: var(--status-verified); }
        .marker-color-orange { background-color: var(--status-action); }
        .marker-color-gray { background-color: var(--status-false); }
        .marker-color-red { background-color: #dc3545; }
    </style>
</head>
<body>

    <div id="app-container" style="display: none;">
        <nav class="navbar">
            <a href="/" class="navbar-brand">
                <img src="imgggg/aquasentry_icon.png" alt="AquaSentry Logo" class="navbar-icon">
                <span>AquaSentry Analyst</span>
            </a>
            <div class="nav-links">
                <button id="nav-map" class="active">Map View</button>
                <button id="nav-table">Report Log</button>
            </div>
            <div class="nav-right">
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
        </nav>

        <main>
            <div id="map-view" class="view active">
                <div id="map"></div>
                <div id="filter-controls">
                    <button class="filter-btn active" data-filter="all">All Reports</button>
                    <button class="filter-btn" data-filter="Crowdsource">Crowdsource</button>
                    <button class="filter-btn" data-filter="Social Media">Social Media</button>
                </div>
            </div>
            <div id="table-view" class="view">
                <h1 style="padding: 0 1.5rem; margin-top: 1.5rem; margin-bottom: 1.5rem;">Report Log</h1>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Description</th>
                            <th>Source</th>
                            <th>Status</th>
                            <th>Sentiment</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body">
                    </tbody>
                </table>
            </div>

            <aside id="report-sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h2 id="sidebar-title">Report Details</h2>
                    <button class="close-sidebar" onclick="closeSidebar()">&times;</button>
                </div>
                <div class="sidebar-content" id="sidebar-content-area">
                </div>
                <div class="sidebar-actions" id="sidebar-actions-area">
                </div>
            </aside>
        </main>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <p id="alert-message"></p>
            <button id="alert-ok-btn" class="modal-btn">OK</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>
    
    <script>
        const API_BASE_URL = '';
        const appContainer = document.getElementById('app-container');
        let map;
        const markers = L.markerClusterGroup();
        let allReports = [];
        let currentUserRole = null;
        let selectedReportId = null;
        let currentSourceFilter = 'all'; 

        const mapView = document.getElementById('map-view');
        const tableView = document.getElementById('table-view');
        const navMap = document.getElementById('nav-map');
        const navTable = document.getElementById('nav-table');
        const sidebar = document.getElementById('report-sidebar');
        const sidebarContent = document.getElementById('sidebar-content-area');
        const sidebarActions = document.getElementById('sidebar-actions-area');
        
        const modal = document.getElementById('alert-modal');
        const modalMsg = document.getElementById('alert-message');
        const modalOkBtn = document.getElementById('alert-ok-btn');
        function customAlert(message) { modalMsg.textContent = message; modal.style.display = 'flex'; }
        modalOkBtn.onclick = () => { modal.style.display = 'none'; }

        const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        const baseMaps = { "Street": streetMap, "Satellite": satelliteMap };

        function initializeMap() {
            if (map) return;
            map = L.map('map', { 
                layers: [streetMap],
                zoomControl: false
            });
            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            
            const southWest = L.latLng(5.9, 68.1), northEast = L.latLng(35.5, 97.4), bounds = L.latLngBounds(southWest, northEast);
            map.fitBounds(bounds); map.setMaxBounds(bounds); map.setMinZoom(5);
            map.addLayer(markers);
        }
        
        const userIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>`;
        const socialIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448 0H64C28.7 0 0 28.7 0 64v288c0 35.3 28.7 64 64 64h96v84c0 9.8 11.2 15.5 19.1 9.7L304 416h144c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64z"/></svg>`;

        function getMarkerColorForStatus(status) {
            switch (status) {
                case 'new': return 'blue';
                case 'verified': return 'green';
                case 'action_taken': return 'orange';
                case 'false_alarm': return 'gray';
                default: return 'blue';
            }
        }
        
        function getIconSVG(source) {
            return source.toLowerCase() === 'social media' ? socialIconSVG : userIconSVG;
        }

        function filterAndRender() {
            let reportsToRender = allReports;
            
            if (currentSourceFilter.toLowerCase() !== 'all') {
                reportsToRender = allReports.filter(report => 
                    report.source.toLowerCase() === currentSourceFilter.toLowerCase()
                );
            }
            
            if (mapView.classList.contains('active')) {
                renderMap(reportsToRender);
            } else {
                renderTable(reportsToRender);
            }
        }

        function renderMap(reportsToRender) {
            if (!map) initializeMap();
            markers.clearLayers();
            
            reportsToRender.forEach(report => {
                const markerColorClass = `marker-color-${getMarkerColorForStatus(report.status)}`;
                const iconSVG = getIconSVG(report.source);
                const customIcon = L.divIcon({
                    html: `<div class="custom-svg-icon ${markerColorClass}">${iconSVG}</div>`,
                    className: '', iconSize: [30, 30], iconAnchor: [15, 15]
                });
                const marker = L.marker([report.latitude, report.longitude], { icon: customIcon });
                marker.on('click', () => { openSidebarWithReport(report.id); });
                markers.addLayer(marker);
            });
            if (!map.hasLayer(markers)) {
                map.addLayer(markers);
            }
            setTimeout(() => { if(map) map.invalidateSize() }, 10);
        }

        function renderTable(reportsToRender) {
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = ''; 

            reportsToRender.forEach(report => {
                const row = document.createElement('tr');
                row.dataset.reportId = report.id;
                const statusClass = `status-${report.status.replace(/_/g, '-')}`;
                const statusText = report.status.replace('_', ' ');
                const sentimentClass = `sentiment-${report.sentiment}`;

                row.innerHTML = `
                    <td>${report.id}</td>
                    <td>${report.description.substring(0, 40)}${report.description.length > 40 ? '...' : ''}</td>
                    <td>${report.source}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${report.sentiment ? `<span class="sentiment-badge ${sentimentClass}">${report.sentiment}</span>` : 'N/A'}
                    </td>
                    <td>${new Date(report.timestamp).toLocaleString()}</td>
                `;
                row.addEventListener('click', () => { openSidebarWithReport(report.id); });
                tbody.appendChild(row);
            });
        }

        function openSidebarWithReport(reportId) {
            selectedReportId = reportId;
            const report = allReports.find(r => r.id === reportId);
            if (!report) return;

            const statusClass = `status-${report.status.replace(/_/g, '-')}`;
            const statusText = report.status.replace('_', ' ');
            const sentimentClass = `sentiment-${report.sentiment}`;

            let contentHTML = `
                <p><strong>ID:</strong> ${report.id}</p>
                <p><strong>Description:</strong> ${report.description}</p>
                <p><strong>Source:</strong> ${report.source}</p>
                <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${statusText}</span></p>
            `;
            
            if (report.sentiment) {
                contentHTML += `<p><strong>Sentiment:</strong> <span class="sentiment-badge ${sentimentClass}">${report.sentiment}</span></p>`;
            }

            contentHTML += `
                <p><strong>Time:</strong> ${new Date(report.timestamp).toLocaleString()}</p>
                <p><strong>Location:</strong> ${report.latitude.toFixed(5)}, ${report.longitude.toFixed(5)}</p>
            `;

            if (report.image_url) {
                contentHTML += `<img src="${report.image_url}" alt="Hazard Report Image" style="max-width: 100%; border-radius: 8px; margin-top: 1rem;">`;
            }
            sidebarContent.innerHTML = contentHTML;

            let actionsHTML = '';
            if (currentUserRole === 'analyst') {
                actionsHTML += `<label for="analyst-notes">Analyst Notes:</label>
                                <textarea id="analyst-notes" rows="4">${report.notes || ''}</textarea>
                                <div class="status-buttons">`;
                
                if (report.status === 'new') {
                    actionsHTML += `<button class="status-verified" onclick="updateStatus('verified')">Verify</button>
                                    <button class="status-false-alarm" onclick="updateStatus('false_alarm')">Mark as False Alarm</button>`;
                } else if (report.status === 'verified') {
                    actionsHTML += `<button class="status-action-taken" onclick="updateStatus('action_taken')">Mark Action Taken</button>`;
                } else {
                    actionsHTML += `<p>This report has been finalized.</p>`;
                }
                
                if (report.status !== 'new') {
                     actionsHTML += `<button class="status-new" onclick="updateStatus('new')" style="margin-top: 10px;">Revert to New</button>`;
                }
                actionsHTML += `</div>`;
            } else {
                if (report.notes) {
                     actionsHTML += `<label>Analyst Notes:</label><p>${report.notes}</p>`;
                } else {
                     actionsHTML += `<p>No notes for this report.</p>`;
                }
            }
            sidebarActions.innerHTML = actionsHTML;
            sidebar.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            selectedReportId = null;
        }

        async function updateStatus(newStatus) {
            if (!selectedReportId || currentUserRole !== 'analyst') return;
            const notesTextarea = document.getElementById('analyst-notes');
            const analystNotes = notesTextarea ? notesTextarea.value : null;
            const statusButtons = sidebarActions.querySelectorAll('button');
            statusButtons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/api/reports/${selectedReportId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, notes: analystNotes })
                });

                if (!response.ok) {
                     const errData = await response.json();
                    throw new Error(errData.error || `Failed to update status: ${response.status}`);
                }

                const updatedReport = await response.json();
                const index = allReports.findIndex(r => r.id === selectedReportId);
                if (index !== -1) {
                    allReports[index] = updatedReport;
                }
                
                filterAndRender();
                openSidebarWithReport(selectedReportId);
                customAlert(`Report ${selectedReportId} status updated to ${newStatus}.`);

            } catch (error) {
                console.error("Status update failed:", error);
                customAlert(`Error: ${error.message}`);
            }
        }

        function switchView(viewToShow) {
            mapView.classList.remove('active');
            tableView.classList.remove('active');
            navMap.classList.remove('active');
            navTable.classList.remove('active');

            if (viewToShow === 'map') {
                mapView.classList.add('active');
                navMap.classList.add('active');
            } else {
                tableView.classList.add('active');
                navTable.classList.add('active');
            }
            filterAndRender();
            closeSidebar();
        }

        navMap.addEventListener('click', () => switchView('map'));
        navTable.addEventListener('click', () => switchView('table'));

        document.querySelectorAll('#filter-controls button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#filter-controls button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSourceFilter = btn.dataset.filter;
                filterAndRender();
                closeSidebar();
            });
        });

        async function fetchWithRetry(url, options = {}, retries = 5, delay = 2500) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 401) { throw new Error('Unauthorized'); }
                    if (response.ok) { return response; }
                    throw new Error(`Server error: ${response.status}`);
                } catch (error) {
                    if (error.message === 'Unauthorized') { throw error; }
                    console.warn(`Fetch attempt ${i + 1} of ${retries} failed. Retrying in ${delay}ms...`);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 1.5; 
                    } else {
                        throw error; 
                    }
                }
            }
        }
        
        async function fetchInitialData() {
            try {
                const reportResponse = await fetchWithRetry(`/api/reports`);
                allReports = await reportResponse.json(); 
                
                if (mapView.classList.contains('active')) {
                     initializeMap();
                }
                
                currentSourceFilter = 'all';
                document.querySelectorAll('#filter-controls button').forEach(b => b.classList.remove('active'));
                document.querySelector('#filter-controls button[data-filter="all"]').classList.add('active');
                
                filterAndRender();

            } catch (error) {
                console.error('Initial data fetch error:', error);
                if (error.message === 'Unauthorized') {
                    window.location.href = '/login'; 
                } else {
                    customAlert('Could not load reports. Is the server running?');
                }
            }
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            fetch(`/api/logout`, { method: 'POST' })
                .then(() => { window.location.href = '/login'; })
                .catch(err => { console.error('Logout failed', err); window.location.href = '/login'; });
        });

        fetchWithRetry(`/api/check_session`)
            .then(response => response.json())
            .then(data => {
                if (data && data.isLoggedIn && (data.user.role === 'analyst')) {
                    currentUserRole = data.user.role;
                    appContainer.style.display = 'flex';
                    fetchInitialData(); 
                } else if (data && data.isLoggedIn && data.user.role === 'authority') {
                     window.location.href = '/authority';
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Session check failed:', error);
                if (error.message === 'Unauthorized') {
                    window.location.href = '/login';
                } else {
                    customAlert('Could not connect to server. Is it running?');
                }
            });
    </script>
</body>
</html>

